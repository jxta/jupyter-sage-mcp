#!/bin/bash

# Jupyter MCP Server - PostBuild Script for mybinder.org
set -euxo pipefail

echo "🪐 ✨ Setting up Jupyter SageMath MCP Server environment..."

# Ensure we're using the right Python
export PATH="${NB_PYTHON_PREFIX}/bin:${PATH}"

# Install MCP server in development mode
echo "Installing Jupyter MCP Server..."
pip install -e .

# Verify SageMath installation
echo "Verifying SageMath installation..."
python -c "import sage; print('SageMath version:', sage.version.version)"

# Install SageMath kernel
echo "Installing SageMath kernel..."
sage -pip install ipykernel
sage -python -m ipykernel install --user --name sagemath --display-name "SageMath"

# Install Python kernel (if not already installed)
echo "Installing Python kernel..."
python -m ipykernel install --user --name python3 --display-name "Python 3"

# Verify kernel installations
echo "Listing installed kernels..."
jupyter kernelspec list

# Create necessary directories
echo "Creating directories..."
mkdir -p notebooks
mkdir -p exports
mkdir -p logs
mkdir -p templates

# Set up Jupyter extensions
echo "Setting up Jupyter extensions..."
jupyter lab build --dev-build=False --minimize=False

# Enable collaborative features
echo "Enabling Jupyter collaboration..."
pip install --no-deps jupyter-collaboration

# Test MCP server import
echo "Testing MCP server import..."
python -c "from src.jupyter_mcp_server import JupyterMCPServer; print('✅ MCP Server import successful')"

# Test SageMath functionality
echo "Testing SageMath functionality..."
sage -c "print('✅ SageMath test: 2+2 =', 2+2); print('✅ Factor test: factor(12) =', factor(12))"

# Set permissions
chmod +x scripts/*.sh 2>/dev/null || echo "No scripts directory found"

echo "🎉 Setup completed successfully!"
echo "Available kernels:"
jupyter kernelspec list
